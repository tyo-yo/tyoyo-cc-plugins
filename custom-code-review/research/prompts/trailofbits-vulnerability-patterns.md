# Trail of Bits: Common Vulnerability Patterns

**Source:** https://github.com/trailofbits/skills
**Type:** Reference Guide

## Overview

Quick reference for detecting common security issues in code changes. Specialized for blockchain/smart contract security but applicable broadly.

## Pattern Categories

### 1. Security Regressions

**Pattern:** Previously removed code is re-added

**Detection:**
```bash
git log -S "pattern" --all --grep="security\|fix\|CVE"
```

**Red flags:**
- Commit message contains "security", "fix", "CVE", "vulnerability"
- Code removed <6 months ago
- No explanation in current PR for re-addition

### 2. Double Decrease/Increase Bugs

**Pattern:** Same accounting operation twice for same event

**Example:**
```solidity
// Request exit
function requestExit() {
    balance[user] -= amount;  // First decrease
}

// Process exit
function processExit() {
    balance[user] -= amount;  // Second decrease - BUG!
}
```

**Impact:** User balance decremented twice, protocol loses funds

### 3. Missing Validation

**Pattern:** Removed `require`/`assert`/`check` without replacement

**Detection:**
```bash
git diff <range> | grep "^-.*require"
git diff <range> | grep "^-.*assert"
git diff <range> | grep "^-.*revert"
```

**Questions:**
- Was validation moved elsewhere?
- Is it redundant?
- Does removal expose vulnerability?

### 4. Underflow/Overflow

**Pattern:** Arithmetic without SafeMath or checks

**Detection:**
- Look for `+`, `-`, `*`, `/` in Solidity <0.8.0
- Check if SafeMath removed
- Look for unchecked blocks in Solidity >=0.8.0

### 5. Reentrancy

**Pattern:** External call before state update (CEI violation)

**Example:**
```solidity
// VULNERABLE: External call BEFORE state update
function withdraw() {
    uint amount = balances[msg.sender];
    (bool success,) = msg.sender.call{value: amount}("");  // FIRST
    require(success);
    balances[msg.sender] = 0;  // AFTER
}

// SAFE: State update BEFORE external call
function withdraw() {
    uint amount = balances[msg.sender];
    balances[msg.sender] = 0;  // FIRST
    (bool success,) = msg.sender.call{value: amount}("");  // AFTER
    require(success);
}
```

### 6. Access Control Bypass

**Pattern:** Removed or relaxed permission checks

**Detection:**
```bash
git diff <range> | grep "^-.*onlyOwner"
git diff <range> | grep "^-.*onlyAdmin"
git diff <range> | grep "^-.*require.*msg.sender"
```

**Questions:**
- Who can now call this function?
- What's the new trust model?
- Was check moved to caller?

### 7. Race Conditions / Front-Running

**Pattern:** State-dependent logic without protection

**Example:**
```solidity
// Step 1: Approve
function approve(address spender, uint amount) {
    allowance[msg.sender][spender] = amount;
}

// Step 2: User can front-run between approval changes
// Attacker sees tx changing approval from 100 to 50
// Front-runs to spend 100, then spends 50 after = 150 total
```

### 8. Timestamp Manipulation

**Pattern:** Security logic depending on `block.timestamp`

**Example:**
```solidity
// VULNERABLE
require(block.timestamp > deadline, "Too early");
// Miner can manipulate timestamp by ~15 seconds

// SAFER
require(block.number > deadlineBlock, "Too early");
// Block numbers are harder to manipulate
```

### 9. Unchecked Return Values

**Pattern:** External call without checking success

**Example:**
```solidity
// VULNERABLE
token.transfer(user, amount);  // Ignores return value

// SAFE
require(token.transfer(user, amount), "Transfer failed");
// Or use SafeERC20 wrapper
```

### 10. Denial of Service

**Pattern:** Unbounded loops, external call reverts blocking execution

**Detection:**
- Arrays that grow without limit
- Loops over user-controlled array
- Critical function depends on external call success

## Quick Detection Commands

### Find removed security checks
```bash
git diff <range> | grep "^-" | grep -E "require|assert|revert"
```

### Find new external calls
```bash
git diff <range> | grep "^+" | grep -E "\.call|\.delegatecall|\.staticcall"
```

### Find changed access modifiers
```bash
git diff <range> | grep -E "onlyOwner|onlyAdmin|internal|private|public|external"
```

### Find arithmetic changes
```bash
git diff <range> | grep -E "\+|\-|\*|/"
```

## Domain-Specific Resources

For specialized contexts:
- `domain-specific-audits/defi-bridges/` - 127 bridge-specific findings
- `domain-specific-audits/tick-math/` - 81 tick math findings
- `domain-specific-audits/merkle-trees/` - 67 merkle tree findings
- `not-so-smart-contracts` - Automated Solidity detectors
- `token-integration-analyzer` - Token integration safety
- `building-secure-contracts` - Solidity best practices
