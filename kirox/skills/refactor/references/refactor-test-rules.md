# テストリファクタリングルール

RED-GREEN-REFACTOR サイクルの REFACTOR フェーズ（テストコード専用）。

## 変えてよいもの／変えてはいけないもの

**変えてよい**: テストケース名・変数名、重複フィクスチャの共通化（pytest fixture化）、アサーションの明確化、インポートの整理・未使用インポートの削除、docstring の追加・改善
**変えてはいけない**: テスト対象の挙動（何をテストしているかの本質）、モックの構造（特に境界・インターフェースの定義部分）、テストの独立性（テスト間の依存を導入しない）
**変えるたびに**: テストを実行してグリーンのまま維持する

## テスト設計

- フレームワークやライブラリが保証する挙動のテストは書かない（Pydantic バリデーション、SDK 型制約、ライブラリのエンコード処理など）
- 自問: 「自分のビジネスロジックをテストしているか、それとも他人のライブラリをテストしているか？」
- 定数値を確認するだけのテスト（`MY_CONSTANT == 42`）は不要
- 既存テストスイートと同じ粒度・fixture・parametrize パターン・アサーションスタイルに揃える
- テスト内のコメントで説明するくらいなら、アサーションに変える
- 各テストケースには、テストシナリオを説明する1行 docstring を書く
- 呼び出し回数だけをアサートする「空のテスト」は書かない。実際の振る舞い・出力を検証する
- テスト追加は実装コスト vs 影響度で優先順位をつける（既存ファイルへの追加 > 新規ファイル > 複雑モック）
- モック数がアサーション数を超えたら、テスト対象の設計を疑う
- テストヘルパー / テストユーティリティを過剰に作らない。テストコードは多少の重複を許容してよい

## 命名

- テストファイル名はテスト対象と一致させる: executor のテストなのに `test_app.py` → `test_executor.py`
- テスト関数名は「何をテストしているか」が一目でわかるようにする

## リファクタリングチェックリスト

各変更後にテストを実行してグリーンを確認する:

- [ ] テスト妥当性: フレームワークの挙動ではなく、ビジネスロジックを検証しているか？
- [ ] 命名: テスト名・変数名が「何をテストしているか」を正確に表しているか？
- [ ] 重複: 同じセットアップコードが複数テストにコピペされていないか？
- [ ] アサーション: 検証内容が具体的で、失敗時のメッセージが意味をなすか？
- [ ] デッドコード: 未使用のインポート、未アサートの変数はないか？
- [ ] モック: モック数 > アサーション数になっていないか？
